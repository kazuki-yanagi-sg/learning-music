services:
  backend:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - .:/app
      - /var/run/docker.sock:/var/run/docker.sock
      - audio_temp:/tmp/anisong_audio
      - midi_temp:/tmp/anisong_midi
    env_file:
      - ../.env
    depends_on:
      - magenta

  magenta:
    image: tensorflow/magenta:latest
    volumes:
      - audio_temp:/input:ro
      - midi_temp:/output
    entrypoint: ["sleep", "infinity"]

  test:
    build: .
    volumes:
      - .:/app
    command: pytest -v
    environment:
      - YOUTUBE_API_KEY=test_key
      - GEMINI_API_KEY=test_key

volumes:
  audio_temp:
  midi_temp:
